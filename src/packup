#!/usr/bin/bash
#
#  Copyright 2016 Matteo Alessio Carrara <sw.matteoac@gmail.com>
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
#  MA 02110-1301, USA.
#

set -e
source /usr/local/lib/bash_colors


# FIXME Verificare meglio conflitti fra file normali e immutabili (sottodirectory)
# TODO Controlli integrità periodici / hash files
# TODO I backup dovrebbero essere read only
# TODO Hash incrementali
# TODO Rimuovere const
# FIXME Gestire meglio nomi strani
# TODO Singola chiamata a md5sum


function check_env_var()
{
	# Devono essere definite queste variabili d'ambiente
	#
	# PACKUP_ROOT	dove vengono salvati i backup (e solo quelli!!)
	# PACKUP_FILES	files da copiare

	# Possono essere definite queste variabili d'ambiente
	#
	# PACKUP_CONST	file che saranno copiati una sola volta e successive modifiche
	# 				saranno ignorate (attenzione, NON devono essere anche
	#				in PACKUP_FILES)
	# CHECK_CONST	se definita, controlla che i file di PACKUP_CONST non siano 
	#				anche in PACKUP_FILES  

	if [[ -z $PACKUP_ROOT ]] || [[ -z $PACKUP_FILES ]]
	then
		clr_red "Le variabili d'ambiente PACKUP_ROOT e PACKUP_FILES devono essere definite"
		exit 1
	fi
}


function execute_hooks()
{
	if [[ $# -lt 1 ]]
	then
		clr_red -n "$FUNCNAME: $LINENO: "; echo "parametri scorretti"
		exit 1
	fi
	
	local HOOKS_DIR=$1

	if [[ -d $HOOKS_DIR ]]
	then
		for f in $(ls $HOOKS_DIR)
		do
			. $HOOKS_DIR/$f
		done
	else
		warn "La directory degli hooks è inesistente ($HOOKS_DIR)"
	fi
}


function check_const_files()
{
	local files="/tmp/packup-files-$(pwd | md5sum | cut -d ' ' -f1)"
	local const="/tmp/packup-const-$(pwd | md5sum | cut -d ' ' -f1)"
	
	printf '%s\n' "${PACKUP_FILES[@]}" | sort > $files
	printf '%s\n' "${PACKUP_CONST[@]}" | sort > $const
	
	local intersect="$(comm -1 -2 $files $const)"
	
	rm -f $files $const

	if [[ -n $intersect ]]
	then
		clr_red "I seguenti file sono definiti sia come file normali che come file costanti:"
		echo $intersect
		exit 1
	fi
}


function save_hash()
{

	if [[ $# -lt 3 ]]
	then
		clr_red -n "$FUNCNAME: $LINENO: "; echo "parametri scorretti"
		exit 1
	fi

	
	local ONLY_NEW="$1"
	local DEST="$2"
	local FILES=("${@:3}")

	
	for f in ${FILES[@]}
	do
		if [[ -d "$f" ]]
		then
			find $f -not -type d | while read ff
			do
				if [[ $ONLY_NEW = "true" ]]
				then 
					[[ -z $(grep -E "  $ff$" $DEST) ]] && md5sum "$ff" >> $DEST
				else
					md5sum "$ff" >> $DEST || true # link corrotto?
				fi
			done
		else
			if [[ $ONLY_NEW = "true" ]]
			then 
				[[ -z $(grep -E "  $f$" $DEST) ]] && md5sum "$f" >> $DEST
			else
				md5sum "$f" >> $DEST # link corrotto?
			fi
		fi
	done
}


function main()
{
	check_env_var

	local PRE_HOOKS_DIR=~/packup/pre
	local POST_HOOKS_DIR=~/packup/post
	local DEST="$PACKUP_ROOT/$(date --iso-8601=seconds)"
	local PREV_BKUP="$(find $PACKUP_ROOT -maxdepth 1 -type d | sort | tail -n 1)"
	local OPT_CMD=$([[ -n $PREV_BKUP ]] && echo "--link-dest=$PREV_BKUP" || echo -n "")
	local RSYNC_FLAGS="--archive --relative --hard-links --human-readable	--info=misc2,name,skip,stats,symsafe $OPT_CMD"
	local FILES_HASH_DEST="$PACKUP_ROOT/$(date --iso-8601=seconds)-hash"
	local CONST_FILES_HASH_DEST="$PACKUP_ROOT/const-hash"

	[[ -n $PREV_BKUP ]] && inf Individuato backup precedente \($PREV_BKUP\)

	inf "Esecuzione degli script di pre-backup..."
	execute_hooks $PRE_HOOKS_DIR

	[[ -n $PACKUP_CONST ]] && [[ -n $CHECK_CONST ]] && check_const_files


	mkdir $DEST
	
	inf "Copia dei file..."
	rsync $RSYNC_FLAGS ${PACKUP_FILES[@]} $DEST
	
	if [[ -n $PACKUP_CONST ]]
	then
		inf "Copia dei file immutabili..."
		rsync $RSYNC_FLAGS --ignore-existing ${PACKUP_CONST[@]} $DEST
	fi
	
	
	inf "Salvataggio degli hash..."
	
	[[ ! -e $FILES_HASH_DEST ]] && touch $FILES_HASH_DEST
	[[ ! -e $CONST_FILES_HASH_DEST ]] && touch $CONST_FILES_HASH_DEST
	
	# FIXME Passaggio di path con spazio all'interno?
	[[ -n $PACKUP_FILES ]] && save_hash false $FILES_HASH_DEST ${PACKUP_FILES[@]}
	[[ -n $PACKUP_CONST ]] && save_hash true $CONST_FILES_HASH_DEST ${PACKUP_CONST[@]}


	inf "Esecuzione degli script di post-backup.."
	execute_hooks $POST_HOOKS_DIR
	
	inf "Backup terminato"
}


main
